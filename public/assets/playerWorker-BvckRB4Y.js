(function(){"use strict";function _(u){const a=u.split(":").map(i=>parseInt(i,10));return a.length===2&&!Number.isNaN(a[0])&&!Number.isNaN(a[1])?a[0]*60+a[1]:null}function $(u){const o=(u||"").trim().split(/\s+/).filter(Boolean).length/2.5;return Math.max(2,Math.min(120,Math.round(o)))}function k(u){const a=(u||"").split(`
`),i=[];let o=1,r={character_extended:!1,note:!1};const g=new Set,f=new Map;for(let p=0;p<a.length;p++){const l=a[p],t=l.trim();if(!t){r.character_extended=!1,i.push({id:`line-${p}`,text:l,index:p,type:"blank",className:"blank-line",speaker:null});continue}let e="action",s="action",m=null;if(r.note)t.includes("]]")&&(r.note=!1),e="note",s="note";else if(t.includes("[["))r.note=!t.includes("]]"),e="note",s="note";else if(/^(INT\.|EXT\.|EST\.|I\/E\.|\.)/i.test(t))r.character_extended=!1,e="scene",s="scene-heading";else if(/^(FADE IN:|FADE OUT\.|FADE TO BLACK\.|CUT TO:|CUT TO BLACK\.|DISSOLVE TO:|SMASH CUT TO:)/.test(t)||/TO:$/.test(t))r.character_extended=!1,e="transition",s="transition";else if(/^[A-Z][A-Z0-9#\.\'\-\s]*(\^)?$/.test(t)&&t.replace("^","").length<50&&t.length>1||/^@.+$/.test(t)){r.character_extended=!0,t.includes("^")?(e="dual_character",s="dual-character"):(e="character",s="character"),m=t;const n=t.replace(/[@^]/g,"").trim().toUpperCase();g.add(n),f.has(n)||f.set(n,0)}else if(r.character_extended){if(/^\(.*\)$/.test(t))e="parenthetical",s="parenthetical";else if(e="dialogue",s="dialogue",m){const n=m.replace(/[@^]/g,"").trim().toUpperCase();f.has(n)&&f.set(n,f.get(n)+1)}}else if(/^= /.test(t))r.character_extended=!1,e="synopsis",s="synopsis";else if(/^~ /.test(t))r.character_extended=!1,e="lyrics",s="lyrics";else if(/^- /.test(t))r.character_extended=!1,e="milestone",s="milestone";else if(/^\d{1,2}:\d{2}$/.test(t))r.character_extended=!1,e="duration",s="duration";else if(/^\[i\]https?:\/\/.+/i.test(t))r.character_extended=!1,e="image",s="image";else if(/^\[a\]https?:\/\/.+/i.test(t))r.character_extended=!1,e="audio",s="audio";else if(/^(title|credit|author[s]?|source|notes|draft date|date|contact|copyright):/i.test(t)){r.character_extended=!1;const n=t.match(/^(title|credit|author[s]?|source|notes|draft date|date|contact|copyright):/i);n&&(n[1].toLowerCase()==="title"?(e="title",s="title-page-title"):(e="title_page",s="title-page-element"))}else if(/^#{1,4}\s/.test(t)){r.character_extended=!1;const n=t.match(/^(#{1,4})/)[1].length;e="section",s=`section-${n}`}else/^={3,}$/.test(t)?(r.character_extended=!1,i.push({id:`page-number-${p}`,text:`<div class="page-number">${o}</div>`,index:p,type:"page_number",className:"page-number",speaker:null}),o++,e="page_break",s="page-break"):/^>.+<$/.test(t)?(r.character_extended=!1,e="centered",s="centered"):(r.character_extended=!1,e="action",s="action");let d=l;if(e==="title")d=l.replace(/^title:\s*/i,"");else if(e==="title_page"){const n=l.match(/^([^:]+):\s*(.*)/);n&&(d=`<strong>${n[1]}:</strong> ${n[2]}`)}else e==="image"?d=`<img src="${l.replace(/^\[i\]/i,"")}" alt="Storyboard image" style="max-width: 100%; height: auto; border: 1px solid #ccc; margin: 0.5em 0;" />`:e==="audio"?d=`<audio controls style="width: 100%; margin: 0.5em 0;"><source src="${l.replace(/^\[a\]/i,"")}" type="audio/mpeg">Your browser does not support the audio element.</audio>`:e==="page_break"?d="<hr />":e==="transition"?d=l.replace(/^> /,""):e==="character"||e==="dual_character"?d=l.replace(/^@/,""):e==="scene"?d=l.replace(/^\./,""):e==="centered"&&(d=`> ${l.replace(/^>|<$/g,"")} <`);i.push({id:`line-${p}`,text:d,index:p,type:e,className:s,speaker:m})}i.length>0&&i[i.length-1].type!=="page_break"&&i.push({id:"final-page-number",text:`<div class="page-number">${o}</div>`,index:a.length,type:"page_number",className:"page-number",speaker:null});const h=Array.from(g).sort(),y=new Map(Array.from(f.entries()).sort((p,l)=>p[0].localeCompare(l[0])));return{blocks:i,characters:h,characterLineCounts:y}}function T(u){const a=(u||"").split(`
`),i=[];for(let o=0;o<a.length;o++){const r=a[o].trim();if(/^####\s/.test(r)){const g=r.replace(/^####\s?/,"").trim(),f=o+1;let h=o+1;for(;h<a.length&&!/^#{1,3}\s/.test(a[h].trim())&&!/^####\s/.test(a[h].trim());)h++;const y=h-1,p=a.slice(f,h).join(`
`),{blocks:l}=k(p);let t=null,e="none";const s=l.find(c=>c.type==="duration");if(s){const c=_((s.text||"").trim());c!==null&&(t=c,e="explicit")}const m=l.find(c=>c.type==="image"),d=l.find(c=>c.type==="audio"),n=l.filter(c=>!(!c||c.type==="page_number"||s&&c.id===s.id||m&&c.id===m.id||d&&c.id===d.id));if(t===null){const c=l.map(x=>x.type==="dialogue"||x.type==="action"||x.type==="parenthetical"?x.text:"").join(" ");t=$(c),e="estimated"}i.push({id:`panel-${i.length+1}`,title:g,panelIndex:i.length,startLine:f,endLine:y,duration:t,durationSource:e,imageUrl:m?(m.text||"").replace(/^<img src="?|".*$/g,"").replace(/^\[i\]/i,""):null,audioUrl:d?(d.text||"").replace(/^<audio.*src="?|".*$/g,"").replace(/^\[a\]/i,""):null,blocks:n}),o=h-1}}return i}self.addEventListener("message",u=>{const{data:a}=u;if(!(!a||typeof a.type!="string")&&a.type==="parsePanels"){const i=a.requestId;try{const o=T(a.text||"");self.postMessage({type:"panels",panels:o,requestId:i})}catch(o){self.postMessage({type:"error",message:String(o),requestId:i})}}})})();

(function(){"use strict";function $(h){const a=h.split(":").map(l=>parseInt(l,10));return a.length===2&&!Number.isNaN(a[0])&&!Number.isNaN(a[1])?a[0]*60+a[1]:null}function T(h){const o=(h||"").trim().split(/\s+/).filter(Boolean).length/2.5;return Math.max(2,Math.min(120,Math.round(o)))}function S(h){const a=(h||"").split(`
`),l=[];let o=1,s={character_extended:!1,note:!1};const x=new Set,f=new Map;let u=null;for(let p=0;p<a.length;p++){const c=a[p],t=c.trim();if(!t){s.character_extended=!1,l.push({id:`line-${p}`,text:c,index:p,type:"blank",className:"blank-line",speaker:null});continue}let e="action",n="action",g=u;if(s.note)t.includes("]]")&&(s.note=!1),e="note",n="note";else if(t.includes("[["))s.note=!t.includes("]]"),e="note",n="note";else if(/^(INT\.|EXT\.|EST\.|I\/E\.|\.)/i.test(t))s.character_extended=!1,e="scene",n="scene-heading";else if(/^(FADE IN:|FADE OUT\.|FADE TO BLACK\.|CUT TO:|CUT TO BLACK\.|DISSOLVE TO:|SMASH CUT TO:)/.test(t)||/TO:$/.test(t))s.character_extended=!1,e="transition",n="transition";else if(/^[A-Z][A-Z0-9#\.\'\-\s]*(\^)?$/.test(t)&&t.replace("^","").length<50&&t.length>1||/^@.+$/.test(t)){s.character_extended=!0,t.includes("^")?(e="dual_character",n="dual-character"):(e="character",n="character"),g=t,u=t;const i=t.replace(/[@^]/g,"").trim().toUpperCase();x.add(i),f.has(i)||f.set(i,0)}else if(s.character_extended)if(/^\(.*\)$/.test(t))e="parenthetical",n="parenthetical";else{e="dialogue",n="dialogue";const i=u||g;if(i){const r=i.replace(/[@^]/g,"").trim().toUpperCase();f.has(r)&&f.set(r,f.get(r)+1)}}else if(/^= /.test(t))s.character_extended=!1,u=null,e="synopsis",n="synopsis";else if(/^~ /.test(t))s.character_extended=!1,u=null,e="lyrics",n="lyrics";else if(/^- /.test(t))s.character_extended=!1,u=null,e="milestone",n="milestone";else if(/^\d{1,2}:\d{2}$/.test(t))s.character_extended=!1,u=null,e="duration",n="duration";else if(/^\[i\]https?:\/\/.+/i.test(t))s.character_extended=!1,u=null,e="image",n="image";else if(/^\[a\]https?:\/\/.+/i.test(t))s.character_extended=!1,u=null,e="audio",n="audio";else if(/^(title|credit|author[s]?|source|notes|draft date|date|contact|copyright):/i.test(t)){s.character_extended=!1;const i=t.match(/^(title|credit|author[s]?|source|notes|draft date|date|contact|copyright):/i);i&&(i[1].toLowerCase()==="title"?(e="title",n="title-page-title"):(e="title_page",n="title-page-element"))}else if(/^#{1,4}\s/.test(t)){s.character_extended=!1;const i=t.match(/^(#{1,4})/)[1].length;e="section",n=`section-${i}`}else/^={3,}$/.test(t)?(s.character_extended=!1,l.push({id:`page-number-${p}`,text:`<div class="page-number">${o}</div>`,index:p,type:"page_number",className:"page-number",speaker:null}),o++,e="page_break",n="page-break"):/^>.+<$/.test(t)?(s.character_extended=!1,e="centered",n="centered"):(s.character_extended=!1,u=null,e="action",n="action");let d=c;if(e==="title")d=c.replace(/^title:\s*/i,"");else if(e==="title_page"){const i=c.match(/^([^:]+):\s*(.*)/);i&&(d=`<strong>${i[1]}:</strong> ${i[2]}`)}else e==="image"?d=`<img src="${c.replace(/^\[i\]/i,"")}" alt="Storyboard image" style="max-width: 100%; height: auto; border: 1px solid #ccc; margin: 0.5em 0;" />`:e==="audio"?d=`<audio controls style="width: 100%; margin: 0.5em 0;"><source src="${c.replace(/^\[a\]/i,"")}" type="audio/mpeg">Your browser does not support the audio element.</audio>`:e==="page_break"?d="<hr />":e==="transition"?d=c.replace(/^> /,""):e==="character"||e==="dual_character"?d=c.replace(/^@/,""):e==="scene"?d=c.replace(/^\./,""):e==="centered"&&(d=`> ${c.replace(/^>|<$/g,"")} <`);l.push({id:`line-${p}`,text:d,index:p,type:e,className:n,speaker:g})}l.length>0&&l[l.length-1].type!=="page_break"&&l.push({id:"final-page-number",text:`<div class="page-number">${o}</div>`,index:a.length,type:"page_number",className:"page-number",speaker:null});const m=Array.from(x).sort(),k=new Map(Array.from(f.entries()).sort((p,c)=>p[0].localeCompare(c[0])));return{blocks:l,characters:m,characterLineCounts:k}}function b(h){const a=(h||"").split(`
`),l=[],o=[];for(let s=0;s<a.length;s++){const f=(a[s]||"").trim().match(/^(#{1,3})\s+(.*)/);f&&o.push({level:f[1].length,title:f[2].trim(),line:s})}for(let s=0;s<a.length;s++){const x=a[s].trim();if(/^####\s/.test(x)){const f=x.replace(/^####\s?/,"").trim(),u=s+1;let m=s+1;for(;m<a.length&&!/^#{1,3}\s/.test(a[m].trim())&&!/^####\s/.test(a[m].trim());)m++;const k=m-1,p=a.slice(u,m).join(`
`),{blocks:c}=S(p);let t=null,e="none";const n=c.find(r=>r.type==="duration");if(n){const r=$((n.text||"").trim());r!==null&&(t=r,e="explicit")}const g=c.find(r=>r.type==="image"),d=c.find(r=>r.type==="audio"),i=c.filter(r=>!(!r||r.type==="page_number"||n&&r.id===n.id||g&&r.id===g.id||d&&r.id===d.id));if(t===null){const r=c.map(y=>y.type==="dialogue"||y.type==="action"||y.type==="parenthetical"?y.text:"").join(" ");t=T(r),e="estimated"}l.push({id:`panel-${l.length+1}`,title:f,panelIndex:l.length,startLine:u,endLine:k,duration:t,durationSource:e,imageUrl:g?(g.text||"").replace(/^<img src="?|".*$/g,"").replace(/^\[i\]/i,""):null,audioUrl:d?(d.text||"").replace(/^<audio.*src="?|".*$/g,"").replace(/^\[a\]/i,""):null,blocks:i,nesting:function(){function r(y){for(let _=o.length-1;_>=0;_--)if(o[_].line<u&&o[_].level===y)return o[_].title;return null}return{act:r(1),scene:r(2),sequence:r(3)}}()}),s=m-1}}return l}self.addEventListener("message",h=>{const{data:a}=h;if(!(!a||typeof a.type!="string")&&a.type==="parsePanels"){const l=a.requestId;try{const o=b(a.text||"");self.postMessage({type:"panels",panels:o,requestId:l})}catch(o){self.postMessage({type:"error",message:String(o),requestId:l})}}})})();

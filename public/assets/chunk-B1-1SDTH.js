function k(m){const i=m.split(":").map(l=>parseInt(l,10));return i.length===2&&!Number.isNaN(i[0])&&!Number.isNaN(i[1])?i[0]*60+i[1]:null}function T(m){const p=(m||"").trim().split(/\s+/).filter(Boolean).length/2.5;return Math.max(2,Math.min(120,Math.round(p)))}function b(m){const i=(m||"").split(`
`),l=[];let p=1,a={character_extended:!1,note:!1};const g=new Set,u=new Map;for(let d=0;d<i.length;d++){const c=i[d],t=c.trim();if(!t){a.character_extended=!1,l.push({id:`line-${d}`,text:c,index:d,type:"blank",className:"blank-line",speaker:null});continue}let e="action",s="action",h=null;if(a.note)t.includes("]]")&&(a.note=!1),e="note",s="note";else if(t.includes("[["))a.note=!t.includes("]]"),e="note",s="note";else if(/^(INT\.|EXT\.|EST\.|I\/E\.|\.)/i.test(t))a.character_extended=!1,e="scene",s="scene-heading";else if(/^(FADE IN:|FADE OUT\.|FADE TO BLACK\.|CUT TO:|CUT TO BLACK\.|DISSOLVE TO:|SMASH CUT TO:)/.test(t)||/TO:$/.test(t))a.character_extended=!1,e="transition",s="transition";else if(/^[A-Z][A-Z0-9#\.\'\-\s]*(\^)?$/.test(t)&&t.replace("^","").length<50&&t.length>1||/^@.+$/.test(t)){a.character_extended=!0,t.includes("^")?(e="dual_character",s="dual-character"):(e="character",s="character"),h=t;const n=t.replace(/[@^]/g,"").trim().toUpperCase();g.add(n),u.has(n)||u.set(n,0)}else if(a.character_extended){if(/^\(.*\)$/.test(t))e="parenthetical",s="parenthetical";else if(e="dialogue",s="dialogue",h){const n=h.replace(/[@^]/g,"").trim().toUpperCase();u.has(n)&&u.set(n,u.get(n)+1)}}else if(/^= /.test(t))a.character_extended=!1,e="synopsis",s="synopsis";else if(/^~ /.test(t))a.character_extended=!1,e="lyrics",s="lyrics";else if(/^- /.test(t))a.character_extended=!1,e="milestone",s="milestone";else if(/^\d{1,2}:\d{2}$/.test(t))a.character_extended=!1,e="duration",s="duration";else if(/^\[i\]https?:\/\/.+/i.test(t))a.character_extended=!1,e="image",s="image";else if(/^\[a\]https?:\/\/.+/i.test(t))a.character_extended=!1,e="audio",s="audio";else if(/^(title|credit|author[s]?|source|notes|draft date|date|contact|copyright):/i.test(t)){a.character_extended=!1;const n=t.match(/^(title|credit|author[s]?|source|notes|draft date|date|contact|copyright):/i);n&&(n[1].toLowerCase()==="title"?(e="title",s="title-page-title"):(e="title_page",s="title-page-element"))}else if(/^#{1,4}\s/.test(t)){a.character_extended=!1;const n=t.match(/^(#{1,4})/)[1].length;e="section",s=`section-${n}`}else/^={3,}$/.test(t)?(a.character_extended=!1,l.push({id:`page-number-${d}`,text:`<div class="page-number">${p}</div>`,index:d,type:"page_number",className:"page-number",speaker:null}),p++,e="page_break",s="page-break"):/^>.+<$/.test(t)?(a.character_extended=!1,e="centered",s="centered"):(a.character_extended=!1,e="action",s="action");let o=c;if(e==="title")o=c.replace(/^title:\s*/i,"");else if(e==="title_page"){const n=c.match(/^([^:]+):\s*(.*)/);n&&(o=`<strong>${n[1]}:</strong> ${n[2]}`)}else e==="image"?o=`<img src="${c.replace(/^\[i\]/i,"")}" alt="Storyboard image" style="max-width: 100%; height: auto; border: 1px solid #ccc; margin: 0.5em 0;" />`:e==="audio"?o=`<audio controls style="width: 100%; margin: 0.5em 0;"><source src="${c.replace(/^\[a\]/i,"")}" type="audio/mpeg">Your browser does not support the audio element.</audio>`:e==="page_break"?o="<hr />":e==="transition"?o=c.replace(/^> /,""):e==="character"||e==="dual_character"?o=c.replace(/^@/,""):e==="scene"?o=c.replace(/^\./,""):e==="centered"&&(o=`> ${c.replace(/^>|<$/g,"")} <`);l.push({id:`line-${d}`,text:o,index:d,type:e,className:s,speaker:h})}l.length>0&&l[l.length-1].type!=="page_break"&&l.push({id:"final-page-number",text:`<div class="page-number">${p}</div>`,index:i.length,type:"page_number",className:"page-number",speaker:null});const y=Array.from(g).sort(),f=new Map(Array.from(u.entries()).sort((d,c)=>d[0].localeCompare(c[0])));return{blocks:l,characters:y,characterLineCounts:f}}function S(m){const i=(m||"").split(`
`),l=[],p=[];for(let a=0;a<i.length;a++){const u=(i[a]||"").trim().match(/^(#{1,3})\s+(.*)/);u&&p.push({level:u[1].length,title:u[2].trim(),line:a})}for(let a=0;a<i.length;a++){const g=i[a].trim();if(/^####\s/.test(g)){const u=g.replace(/^####\s?/,"").trim(),y=a+1;let f=a+1;for(;f<i.length&&!/^#{1,3}\s/.test(i[f].trim())&&!/^####\s/.test(i[f].trim());)f++;const d=f-1,c=i.slice(y,f).join(`
`),{blocks:t}=b(c);let e=null,s="none";const h=t.find(r=>r.type==="duration");if(h){const r=k((h.text||"").trim());r!==null&&(e=r,s="explicit")}const o=t.find(r=>r.type==="image"),n=t.find(r=>r.type==="audio"),$=t.filter(r=>!(!r||r.type==="page_number"||h&&r.id===h.id||o&&r.id===o.id||n&&r.id===n.id));if(e===null){const r=t.map(x=>x.type==="dialogue"||x.type==="action"||x.type==="parenthetical"?x.text:"").join(" ");e=T(r),s="estimated"}l.push({id:`panel-${l.length+1}`,title:u,panelIndex:l.length,startLine:y,endLine:d,duration:e,durationSource:s,imageUrl:o?(o.text||"").replace(/^<img src="?|".*$/g,"").replace(/^\[i\]/i,""):null,audioUrl:n?(n.text||"").replace(/^<audio.*src="?|".*$/g,"").replace(/^\[a\]/i,""):null,blocks:$,nesting:function(){function r(x){for(let _=p.length-1;_>=0;_--)if(p[_].line<y&&p[_].level===x)return p[_].title;return null}return{act:r(1),scene:r(2),sequence:r(3)}}()}),a=f-1}}return l}export{S as a,b as p};

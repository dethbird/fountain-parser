const _={PAGE_BREAK:/^\={3,}$/,CHARACTER:/^[\p{Lu}][\p{Lu}\p{N}'\-. \t]+(?:\s*(\([^\n()]+\))\s*)?(?:\^)?\s*$/u,CHARACTER_POWER_USER:/^@([\p{L}\p{N}'\-. ][\p{L}\p{N}'\-. ]*)(?:\s*(\([^\n()]+\))\s*)?(?:\^)?\s*$/u,SCENE:/^((?:\*{0,3}_?)?(?:(?:int|ext|est|i\/e)[. ]).+)|^(?:\.(?!\.+))(.+)/i,TRANSITION:/^(?:FADE(?: IN| OUT| TO BLACK)?[:.]|CUT TO BLACK\.|SMASH CUT TO:|MATCH CUT TO:|DISSOLVE TO:|WIPE TO:|CUT TO:|BACK TO:)/i,TRANSITION_POWER_USER:/^(?:> )(.+)/i,TITLE:new RegExp(String.raw`^(?:(title|credit|author|authors|writer|writers|written\s+by|screenplay\s+by|teleplay\s+by|story\s+by|adaptation\s+by|source|based\s+on(?:\s+characters\s+by)?|notes|draft(?:\s+date)?|revision(?:\s+date|(?:\s+)?color)?|draft\s*#|date|contact|copyright|wga(?:\s+registration)?|registration(?:\s*#)?|series|episode(?:\s+title)?|showrunner|production(?:\s+company)?)\s*):\s*`,"i"),SECTION:/^(#{1,4})\ (.*)/,MILESTONE:/^(?:\ +)?-\ (.+)/,IMAGE:/^(\[i\](?:https?:\/\/|file:\/\/\/).+)/i,AUDIO:/^(\[a\](?:https?:\/\/|file:\/\/\/).+)/i};function C(g){const i=g.split(":").map(c=>parseInt(c,10));return i.length===2&&!Number.isNaN(i[0])&&!Number.isNaN(i[1])?i[0]*60+i[1]:null}function S(g){const f=(g||"").trim().split(/\s+/).filter(Boolean).length/2.5;return Math.max(2,Math.min(120,Math.round(f)))}function A(g){const i=(g||"").split(`
`),c=[];let f=1,s={character_extended:!1,note:!1};const T=new Set,p=new Map;let d=null;for(let u=0;u<i.length;u++){const l=i[u],t=l.trim();if(!t){s.character_extended=!1,c.push({id:`line-${u}`,text:l,index:u,type:"blank",className:"blank-line",speaker:null});continue}let e="action",a="action",m=d;if(s.note)t.includes("]]")&&(s.note=!1),e="note",a="note";else if(t.includes("[["))s.note=!t.includes("]]"),e="note",a="note";else if(/^(INT\.|EXT\.|EST\.|I\/E\.|\.)/i.test(t))s.character_extended=!1,e="scene",a="scene-heading";else if(/^(FADE IN:|FADE OUT\.|FADE TO BLACK\.|CUT TO:|CUT TO BLACK\.|DISSOLVE TO:|SMASH CUT TO:)/.test(t)||/TO:$/.test(t))s.character_extended=!1,e="transition",a="transition";else if(/^[A-Z][A-Z0-9#\.\'\-\s]*(\^)?$/.test(t)&&t.replace("^","").length<50&&t.length>1||/^@.+$/.test(t)){s.character_extended=!0,t.includes("^")?(e="dual_character",a="dual-character"):(e="character",a="character"),m=t,d=t;const r=t.replace(/[@^]/g,"").trim().toUpperCase();T.add(r),p.has(r)||p.set(r,0)}else if(s.character_extended)if(/^\(.*\)$/.test(t))e="parenthetical",a="parenthetical";else{e="dialogue",a="dialogue";const r=d||m;if(r){const n=r.replace(/[@^]/g,"").trim().toUpperCase();p.has(n)&&p.set(n,p.get(n)+1)}}else if(/^= /.test(t))s.character_extended=!1,d=null,e="synopsis",a="synopsis";else if(/^~ /.test(t))s.character_extended=!1,d=null,e="lyrics",a="lyrics";else if(/^- /.test(t))s.character_extended=!1,d=null,e="milestone",a="milestone";else if(/^\d{1,2}:\d{2}$/.test(t))s.character_extended=!1,d=null,e="duration",a="duration";else if(/^\[i\]https?:\/\/.+/i.test(t))s.character_extended=!1,d=null,e="image",a="image";else if(/^\[a\]https?:\/\/.+/i.test(t))s.character_extended=!1,d=null,e="audio",a="audio";else if(_&&_.TITLE&&_.TITLE.test(t)){s.character_extended=!1;const r=t.match(_.TITLE);r&&(r[1].toLowerCase()==="title"?(e="title",a="title-page-title"):(e="title_page",a="title-page-element"))}else if(/^#{1,4}\s/.test(t)){s.character_extended=!1;const r=t.match(/^(#{1,4})/)[1].length;e="section",a=`section-${r}`}else/^={3,}$/.test(t)?(s.character_extended=!1,c.push({id:`page-number-${u}`,text:`<div class="page-number">${f}</div>`,index:u,type:"page_number",className:"page-number",speaker:null}),f++,e="page_break",a="page-break"):/^>.+<$/.test(t)?(s.character_extended=!1,e="centered",a="centered"):(s.character_extended=!1,d=null,e="action",a="action");let o=l;if(e==="title")o=l.replace(/^title:\s*/i,"");else if(e==="title_page"){const r=l.match(/^([^:]+):\s*(.*)/);r&&(o=`<strong>${r[1]}:</strong> ${r[2]}`)}else e==="image"?o=`<img src="${l.replace(/^\[i\]/i,"")}" alt="Storyboard image" style="max-width: 100%; height: auto; border: 1px solid #ccc; margin: 0.5em 0;" />`:e==="audio"?o=`<audio controls style="width: 100%; margin: 0.5em 0;"><source src="${l.replace(/^\[a\]/i,"")}" type="audio/mpeg">Your browser does not support the audio element.</audio>`:e==="page_break"?o="<hr />":e==="transition"?o=l.replace(/^> /,""):e==="character"||e==="dual_character"?o=l.replace(/^@/,""):e==="scene"?o=l.replace(/^\./,""):e==="centered"&&(o=`> ${l.replace(/^>|<$/g,"")} <`);c.push({id:`line-${u}`,text:o,index:u,type:e,className:a,speaker:m})}c.length>0&&c[c.length-1].type!=="page_break"&&c.push({id:"final-page-number",text:`<div class="page-number">${f}</div>`,index:i.length,type:"page_number",className:"page-number",speaker:null});const h=Array.from(T).sort(),E=new Map(Array.from(p.entries()).sort((u,l)=>u[0].localeCompare(l[0])));return{blocks:c,characters:h,characterLineCounts:E}}function O(g){const i=(g||"").split(`
`),c=[],f=[];for(let s=0;s<i.length;s++){const p=(i[s]||"").trim().match(/^(#{1,3})\s+(.*)/);p&&f.push({level:p[1].length,title:p[2].trim(),line:s})}for(let s=0;s<i.length;s++){const T=i[s].trim();if(/^####\s/.test(T)){const p=T.replace(/^####\s?/,"").trim(),d=s+1;let h=s+1;for(;h<i.length&&!/^#{1,3}\s/.test(i[h].trim())&&!/^####\s/.test(i[h].trim());)h++;const E=h-1,u=i.slice(d,h).join(`
`),{blocks:l}=A(u);let t=null,e="none";const a=l.find(n=>n.type==="duration");if(a){const n=C((a.text||"").trim());n!==null&&(t=n,e="explicit")}const m=l.find(n=>n.type==="image"),o=l.find(n=>n.type==="audio"),r=l.filter(n=>!(!n||n.type==="page_number"||a&&n.id===a.id||m&&n.id===m.id||o&&n.id===o.id));if(t===null){const n=l.map(x=>x.type==="dialogue"||x.type==="action"||x.type==="parenthetical"?x.text:"").join(" ");t=S(n),e="estimated"}c.push({id:`panel-${c.length+1}`,title:p,panelIndex:c.length,startLine:d,endLine:E,duration:t,durationSource:e,imageUrl:m?(m.text||"").replace(/^<img src="?|".*$/g,"").replace(/^\[i\]/i,""):null,audioUrl:o?(o.text||"").replace(/^<audio.*src="?|".*$/g,"").replace(/^\[a\]/i,""):null,blocks:r,nesting:function(){function n(x){for(let y=f.length-1;y>=0;y--)if(f[y].line<d&&f[y].level===x)return f[y].title;return null}return{act:n(1),scene:n(2),sequence:n(3)}}()}),s=h-1}}return c}export{_ as B,O as a,A as p};

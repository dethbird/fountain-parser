(function(){"use strict";function k(f){const a=f.split(":").map(l=>parseInt(l,10));return a.length===2&&!Number.isNaN(a[0])&&!Number.isNaN(a[1])?a[0]*60+a[1]:null}function T(f){const c=(f||"").trim().split(/\s+/).filter(Boolean).length/2.5;return Math.max(2,Math.min(120,Math.round(c)))}function b(f){const a=(f||"").split(`
`),l=[];let c=1,s={character_extended:!1,note:!1};const g=new Set,p=new Map;for(let u=0;u<a.length;u++){const o=a[u],t=o.trim();if(!t){s.character_extended=!1,l.push({id:`line-${u}`,text:o,index:u,type:"blank",className:"blank-line",speaker:null});continue}let e="action",n="action",m=null;if(s.note)t.includes("]]")&&(s.note=!1),e="note",n="note";else if(t.includes("[["))s.note=!t.includes("]]"),e="note",n="note";else if(/^(INT\.|EXT\.|EST\.|I\/E\.|\.)/i.test(t))s.character_extended=!1,e="scene",n="scene-heading";else if(/^(FADE IN:|FADE OUT\.|FADE TO BLACK\.|CUT TO:|CUT TO BLACK\.|DISSOLVE TO:|SMASH CUT TO:)/.test(t)||/TO:$/.test(t))s.character_extended=!1,e="transition",n="transition";else if(/^[A-Z][A-Z0-9#\.\'\-\s]*(\^)?$/.test(t)&&t.replace("^","").length<50&&t.length>1||/^@.+$/.test(t)){s.character_extended=!0,t.includes("^")?(e="dual_character",n="dual-character"):(e="character",n="character"),m=t;const r=t.replace(/[@^]/g,"").trim().toUpperCase();g.add(r),p.has(r)||p.set(r,0)}else if(s.character_extended){if(/^\(.*\)$/.test(t))e="parenthetical",n="parenthetical";else if(e="dialogue",n="dialogue",m){const r=m.replace(/[@^]/g,"").trim().toUpperCase();p.has(r)&&p.set(r,p.get(r)+1)}}else if(/^= /.test(t))s.character_extended=!1,e="synopsis",n="synopsis";else if(/^~ /.test(t))s.character_extended=!1,e="lyrics",n="lyrics";else if(/^- /.test(t))s.character_extended=!1,e="milestone",n="milestone";else if(/^\d{1,2}:\d{2}$/.test(t))s.character_extended=!1,e="duration",n="duration";else if(/^\[i\]https?:\/\/.+/i.test(t))s.character_extended=!1,e="image",n="image";else if(/^\[a\]https?:\/\/.+/i.test(t))s.character_extended=!1,e="audio",n="audio";else if(/^(title|credit|author[s]?|source|notes|draft date|date|contact|copyright):/i.test(t)){s.character_extended=!1;const r=t.match(/^(title|credit|author[s]?|source|notes|draft date|date|contact|copyright):/i);r&&(r[1].toLowerCase()==="title"?(e="title",n="title-page-title"):(e="title_page",n="title-page-element"))}else if(/^#{1,4}\s/.test(t)){s.character_extended=!1;const r=t.match(/^(#{1,4})/)[1].length;e="section",n=`section-${r}`}else/^={3,}$/.test(t)?(s.character_extended=!1,l.push({id:`page-number-${u}`,text:`<div class="page-number">${c}</div>`,index:u,type:"page_number",className:"page-number",speaker:null}),c++,e="page_break",n="page-break"):/^>.+<$/.test(t)?(s.character_extended=!1,e="centered",n="centered"):(s.character_extended=!1,e="action",n="action");let d=o;if(e==="title")d=o.replace(/^title:\s*/i,"");else if(e==="title_page"){const r=o.match(/^([^:]+):\s*(.*)/);r&&(d=`<strong>${r[1]}:</strong> ${r[2]}`)}else e==="image"?d=`<img src="${o.replace(/^\[i\]/i,"")}" alt="Storyboard image" style="max-width: 100%; height: auto; border: 1px solid #ccc; margin: 0.5em 0;" />`:e==="audio"?d=`<audio controls style="width: 100%; margin: 0.5em 0;"><source src="${o.replace(/^\[a\]/i,"")}" type="audio/mpeg">Your browser does not support the audio element.</audio>`:e==="page_break"?d="<hr />":e==="transition"?d=o.replace(/^> /,""):e==="character"||e==="dual_character"?d=o.replace(/^@/,""):e==="scene"?d=o.replace(/^\./,""):e==="centered"&&(d=`> ${o.replace(/^>|<$/g,"")} <`);l.push({id:`line-${u}`,text:d,index:u,type:e,className:n,speaker:m})}l.length>0&&l[l.length-1].type!=="page_break"&&l.push({id:"final-page-number",text:`<div class="page-number">${c}</div>`,index:a.length,type:"page_number",className:"page-number",speaker:null});const y=Array.from(g).sort(),h=new Map(Array.from(p.entries()).sort((u,o)=>u[0].localeCompare(o[0])));return{blocks:l,characters:y,characterLineCounts:h}}function S(f){const a=(f||"").split(`
`),l=[],c=[];for(let s=0;s<a.length;s++){const p=(a[s]||"").trim().match(/^(#{1,3})\s+(.*)/);p&&c.push({level:p[1].length,title:p[2].trim(),line:s})}for(let s=0;s<a.length;s++){const g=a[s].trim();if(/^####\s/.test(g)){const p=g.replace(/^####\s?/,"").trim(),y=s+1;let h=s+1;for(;h<a.length&&!/^#{1,3}\s/.test(a[h].trim())&&!/^####\s/.test(a[h].trim());)h++;const u=h-1,o=a.slice(y,h).join(`
`),{blocks:t}=b(o);let e=null,n="none";const m=t.find(i=>i.type==="duration");if(m){const i=k((m.text||"").trim());i!==null&&(e=i,n="explicit")}const d=t.find(i=>i.type==="image"),r=t.find(i=>i.type==="audio"),$=t.filter(i=>!(!i||i.type==="page_number"||m&&i.id===m.id||d&&i.id===d.id||r&&i.id===r.id));if(e===null){const i=t.map(x=>x.type==="dialogue"||x.type==="action"||x.type==="parenthetical"?x.text:"").join(" ");e=T(i),n="estimated"}l.push({id:`panel-${l.length+1}`,title:p,panelIndex:l.length,startLine:y,endLine:u,duration:e,durationSource:n,imageUrl:d?(d.text||"").replace(/^<img src="?|".*$/g,"").replace(/^\[i\]/i,""):null,audioUrl:r?(r.text||"").replace(/^<audio.*src="?|".*$/g,"").replace(/^\[a\]/i,""):null,blocks:$,nesting:function(){function i(x){for(let _=c.length-1;_>=0;_--)if(c[_].line<y&&c[_].level===x)return c[_].title;return null}return{act:i(1),sequence:i(2),scene:i(3)}}()}),s=h-1}}return l}self.addEventListener("message",f=>{const{data:a}=f;if(!(!a||typeof a.type!="string")&&a.type==="parsePanels"){const l=a.requestId;try{const c=S(a.text||"");self.postMessage({type:"panels",panels:c,requestId:l})}catch(c){self.postMessage({type:"error",message:String(c),requestId:l})}}})})();

(function(){"use strict";function g(f){const p=(f||"").split(`
`),n=[];let o=1,s={character_extended:!1,note:!1};const u=new Set,d=new Map;for(let i=0;i<p.length;i++){const c=p[i],t=c.trim();if(!t){s.character_extended=!1,n.push({id:`line-${i}`,text:c,index:i,type:"blank",className:"blank-line",speaker:null});continue}let e="action",a="action",h=null;if(s.note)t.includes("]]")&&(s.note=!1),e="note",a="note";else if(t.includes("[["))s.note=!t.includes("]]"),e="note",a="note";else if(/^(INT\.|EXT\.|EST\.|I\/E\.|\.)/i.test(t))s.character_extended=!1,e="scene",a="scene-heading";else if(/^(FADE IN:|FADE OUT\.|FADE TO BLACK\.|CUT TO:|CUT TO BLACK\.|DISSOLVE TO:|SMASH CUT TO:)/.test(t)||/TO:$/.test(t))s.character_extended=!1,e="transition",a="transition";else if(/^[A-Z][A-Z0-9#\.\'\-\s]*(\^)?$/.test(t)&&t.replace("^","").length<50&&t.length>1||/^@.+$/.test(t)){s.character_extended=!0,t.includes("^")?(e="dual_character",a="dual-character"):(e="character",a="character"),h=t;const r=t.replace(/[@^]/g,"").trim().toUpperCase();u.add(r),d.has(r)||d.set(r,0)}else if(s.character_extended){if(/^\(.*\)$/.test(t))e="parenthetical",a="parenthetical";else if(e="dialogue",a="dialogue",h){const r=h.replace(/[@^]/g,"").trim().toUpperCase();d.has(r)&&d.set(r,d.get(r)+1)}}else if(/^= /.test(t))s.character_extended=!1,e="synopsis",a="synopsis";else if(/^~ /.test(t))s.character_extended=!1,e="lyrics",a="lyrics";else if(/^- /.test(t))s.character_extended=!1,e="milestone",a="milestone";else if(/^\d{1,2}:\d{2}$/.test(t))s.character_extended=!1,e="duration",a="duration";else if(/^\[i\]https?:\/\/.+/i.test(t))s.character_extended=!1,e="image",a="image";else if(/^\[a\]https?:\/\/.+/i.test(t))s.character_extended=!1,e="audio",a="audio";else if(/^(title|credit|author[s]?|source|notes|draft date|date|contact|copyright):/i.test(t)){s.character_extended=!1;const r=t.match(/^(title|credit|author[s]?|source|notes|draft date|date|contact|copyright):/i);r&&(r[1].toLowerCase()==="title"?(e="title",a="title-page-title"):(e="title_page",a="title-page-element"))}else if(/^#{1,4}\s/.test(t)){s.character_extended=!1;const r=t.match(/^(#{1,4})/)[1].length;e="section",a=`section-${r}`}else/^={3,}$/.test(t)?(s.character_extended=!1,n.push({id:`page-number-${i}`,text:`<div class="page-number">${o}</div>`,index:i,type:"page_number",className:"page-number",speaker:null}),o++,e="page_break",a="page-break"):/^>.+<$/.test(t)?(s.character_extended=!1,e="centered",a="centered"):(s.character_extended=!1,e="action",a="action");let l=c;if(e==="title")l=c.replace(/^title:\s*/i,"");else if(e==="title_page"){const r=c.match(/^([^:]+):\s*(.*)/);r&&(l=`<strong>${r[1]}:</strong> ${r[2]}`)}else e==="image"?l=`<img src="${c.replace(/^\[i\]/i,"")}" alt="Storyboard image" style="max-width: 100%; height: auto; border: 1px solid #ccc; margin: 0.5em 0;" />`:e==="audio"?l=`<audio controls style="width: 100%; margin: 0.5em 0;"><source src="${c.replace(/^\[a\]/i,"")}" type="audio/mpeg">Your browser does not support the audio element.</audio>`:e==="page_break"?l="<hr />":e==="transition"?l=c.replace(/^> /,""):e==="character"||e==="dual_character"?l=c.replace(/^@/,""):e==="scene"?l=c.replace(/^\./,""):e==="centered"&&(l=`> ${c.replace(/^>|<$/g,"")} <`);n.push({id:`line-${i}`,text:l,index:i,type:e,className:a,speaker:h})}n.length>0&&n[n.length-1].type!=="page_break"&&n.push({id:"final-page-number",text:`<div class="page-number">${o}</div>`,index:p.length,type:"page_number",className:"page-number",speaker:null});const m=Array.from(u).sort(),x=new Map(Array.from(d.entries()).sort((i,c)=>i[0].localeCompare(c[0])));return{blocks:n,characters:m,characterLineCounts:x}}self.onmessage=function(f){const{type:p,text:n}=f.data;if(p==="process")try{const o=g(n);self.postMessage({type:"result",blocks:o.blocks,characters:o.characters,characterLineCounts:o.characterLineCounts})}catch(o){self.postMessage({type:"error",message:String(o)})}}})();
